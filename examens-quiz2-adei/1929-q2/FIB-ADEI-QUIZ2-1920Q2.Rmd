---
title: "Q2 ADEI_1920Quiz2"
author: "JÃºlia Gasull"
date: \today
output:
  pdf_document: default
  word_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---


# First setups
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo = T, results = 'hide'}
if(!is.null(dev.list())) dev.off()  # Clear plots
rm(list=ls())                       # Clean workspace
```

## Load Required Packages for this deliverable
We load the necessary packages and set working directory
```{r echo = T, results = 'hide', message=FALSE, error=FALSE, warning=FALSE}
setwd("~/Documents/uni/FIB-ADEI/exams/Course 2019-20 Q1 Datasets for Quiz 1 and 2-20201217")
filepath<-"~/Documents/uni/FIB-ADEI/exams/Course 2019-20 Q1 Datasets for Quiz 1 and 2-20201217"

# Load Required Packages
options(contrasts=c("contr.treatment","contr.treatment"))
requiredPackages <- c("missMDA","chemometrics","mvoutlier","effects","FactoMineR","car","lmtest","ggplot2","moments","factoextra","RColorBrewer","dplyr","ggmap","ggthemes","knitr")

missingPackages <- requiredPackages[!(requiredPackages %in% installed.packages()[,"Package"])]
if(length(missingPackages)) install.packages(missingPackages)
lapply(requiredPackages, require, character.only = TRUE)
```

## Load processed data from last deliverable
```{r}
load(paste0(filepath,"/RiskyTransport.RData"))
summary(df)
```

# Enunciat

1793 opcions per part de 561 individus d'un mode de transport des de / cap a l'aeroport de Freetown (Sierra Leone) fins al centre de la ciutat. Aquest problema explota un entorn de transport inusual per generar part del primer valor de preferÃ¨ncia revelat d'una vida estadÃ­stica (VSL) estimat a partir d'un entorn de baixos ingressos. 

Hi ha quatre alternatives disponibles: ferri, helicÃ²pter, taxi aquÃ tic i aerodeslizador.

Una caracterÃ­stica sorprenent de lâ€™estudi Ã©s que totes aquestes alternatives van experimentar accidents mortals en els darrers anys, de manera que el risc de mortalitat no Ã©s menyspreable i difereix molt dâ€™una alternativa a una altra. 

Per exemple, les probabilitats de morir amb el taxi aquÃ tic i lâ€™helicÃ²pter sÃ³n respectivament de 2,55 i 18,41 de cada 100.000 viatges de viatgers.

# DescripciÃ³ de les variables

* id	 Individual id (not to be used in this exercise)
```{r}
df$id <- NULL
```

* choice	 1 for the chosen mode
* mode	 One of Helicopter, (not to be used in this exercise), WaterTaxi (a small craft for 12 to 18 pax), Ferry, and Hovercraft
* cost	 the generalised cost of the transport mode (US$) â€“ numeric target
* risk	 The fatality rate, numbers of death per 100,000 trips for the selected mode
* weight	 Weights (not to be used in this exercise)
* seats	 Level of seat availability - comfort (Likert scale 1 to 5, transformed to 0 to 1 scale)
* noise	Level for less noise disturbance (Likert scale 1 to 5, transformed to 0 to 1 scale)
* crowdness	Level for less crowdedness (Likert scale 1 to 5, transformed to 0 to 1 scale)
* convloc	Level of convenience location for the transfer (Likert scale 1 to 5, transformed to 0 to 1 scale)
* clientele	Level of quality of â€˜trip makersâ€™ (Likert scale 1 to 5, transformed to 0 to 1 scale)
* chid	 Choice situation id (not to be used in this exercise)
* african	 yes if born in Africa, no otherwise
* lifeExp	 declared life expectancy
* dwage	 declared hourly wage
* iwage	 imputed hourly wage
* educ	 level of education, one of low and high
* fatalism	 self-ranking of the degree of fatalism
* gender	 gender, one of female and male
* age	 age
* haveChildren	 yes if the traveler has children, no otherwise
* swim	 yes if the traveler knows how to swim, 'noâ€™, otherwise
* noalt	Number of available alternatives for the selected choice


Sâ€™estimen les compensacions que els individus estan disposats a fer entre el risc de mortalitat i el cost mentre viatgen des de i cap a lâ€™aeroport internacional de Sierra Leone. 

La configuraciÃ³ i el conjunt de dades original ens permeten abordar algunes qÃ¼estions tÃ­piques de variables i tambÃ© comparar les estimacions de VSL per a viatgers de diferents paÃ¯sos, tots ells que sâ€™enfronten a la mateixa situaciÃ³ dâ€™elecciÃ³. 

Lâ€™estimaciÃ³ mitjana de VSL per als viatgers africans de la mostra Ã©s de 577.000 dÃ²lars EUA, en comparaciÃ³ amb 924.000 dÃ²lars nord-americans per als no africans. 

Les dues covariables dâ€™interÃ¨s sÃ³n el cost (el cost generalitzat en unitat de PPP de dÃ²lars, no les lleons) i el risk (mortalitat per cada 100.000 viatges de viatgers). 

La variable de risc, que Ã©s purament alternativa, no permet estimar les interceptacions de les alternatives. 

Per evitar problemes d'endogeneÃ¯tat, els autors introdueixen com a marques de covariables que els individus van donar a 5 atributs de les alternatives: comfort, noise level, crowdedness, convenience and transfer location and the "quality" of the clientele.

*Centrem-nos en el cost del viatge (variable de cost). En primer lloc, restringiu el vostre conjunt de dades actiu a observacions que incloguin 4 alternatives disponibles (noalt = 4) i l'elecciÃ³ real (elecciÃ³ = 1).* 
```{r}
table(df$noalt, df$choice)
sel <- which(df$noalt==4 & df$choice==1); length(sel)
df <- df[sel,]

df$noalt <- NULL
df$choice <- NULL


names(df)
summary(df)
```

*En segon lloc, definiu un nou factor binari que contingui lâ€™elecciÃ³ WaterTaxi enfront dâ€™altres.*
```{r}
df$f.water_taxi[(df$mode == "WaterTaxi")] = "Yes"
df$f.water_taxi[(df$mode != "WaterTaxi")] = "No"
df$f.water_taxi <- factor(df$f.water_taxi)
summary(df$f.water_taxi)
```


*1. Indiqueu mitjanÃ§ant eines dâ€™exploraciÃ³ de dades quines sÃ³n les variables mÃ©s associades globalment a la variable de resposta (cost).*
```{r}
names(df)
res.con<-condes(df,2)
```

```{r}
res.con$quanti
```

Quantitatives:

* dwage       
* iwage       
* crowdness   
* noise      
* convloc     
* seats

```{r}
res.con$category
```

CategÃ²riques:
* mode=Ferry       -46.807796 5.407860e-22
* f.water_taxi=Yes  14.881103 8.924484e-09
* f.water_taxi=No  -14.881103 8.924484e-09
* mode=Hovercraft   10.033656 4.388458e-06
* swim=swim.Yes      5.579331 3.240303e-02
* swim=swim.No      -5.579331 3.240303e-02


Es pot utilitzar un mÃ¨tode condes() al paquet FactoMineR. NomÃ©s sâ€™ha dâ€™abordar lâ€™associaciÃ³ global. Lâ€™associaciÃ³ global del cost amb variables numÃ¨riques es mostra mitjanÃ§ant el coeficient de correlaciÃ³ de Pearson i els valors de la hipÃ²tesi nulÂ·la Â«coeficient de correlaciÃ³ igual a 0Â». 

Es correlaciona positivament amb una intensitat elevada amb el dwage, iwage i es mostra menys intensitat per a puntuacions numÃ¨riques multitud, soroll i convlocaciÃ³. Es mostra una relaciÃ³ inversa indicada per un coeficient de correlaciÃ³ negatiu per a l'expansiÃ³ i el risc de la vida, perÃ² no Ã©s molt intensa.

Les variables factorials relacionades globalment amb el cost sÃ³n el mode de transport seleccionat (baixa intensitat) i gairebÃ© insignificants sÃ³n la capacitat de nataciÃ³ (nedar) i el factor binari WaterTaxi.

*2. Calculeu el model lineal que explica el cost de la transferÃ¨ncia del salari imputat (iwage) i el mode factor: interpreteu les lÃ­nies de regressiÃ³ i avalueu-ne la qualitat global. Quin Ã©s el percentatge de variabilitat de cost que sâ€™explica pel mode de transport?*

El model complet dâ€™Ancova (efectes i interaccions principals) tÃ© 8 parÃ metres i, segons les proves dâ€™Anova () per a efectes nets, les interaccions sÃ³n significatives una vegada que els efectes principals per a iwage i mode ja sâ€™han inclÃ²s al model. 

La bondat dâ€™ajust es pot avaluar amb R2.

El 80,46% de la variabilitat de lâ€™objectiu sâ€™explica pel model. 

Cal introduir el mode de transport al model com a efecte principal i interacciÃ³ amb iwage. El model que nomÃ©s contÃ© iwage tÃ© un R2 del 58,73%, de manera que gairebÃ© el 21% de la variabilitat de l'objectiu s'explica pel mode. El model additiu no Ã©s la soluciÃ³: cal interaccions.

InterpretaciÃ³ del model:
* Per al mode == HelicÃ²pter       Y = (37,14 + 0)     + (2,33 + 0   ) * iwage
* Per al mode == WaterTaxi        Y = (37.14 + 23.16) + (2.33 - 1.49) * iwage
* Per al mode == Ferri            Y = (37,14 - 33,57) + (2,33 - 0,66) * iwage
* Per al mode == Hovercraft       Y = (37,14 + 55,95) + (2,33 - 1,85) * iwage


```{r}
model_1 <- lm(cost ~ iwage*mode,data=df)
summary(model_1)
Anova(model_1)

model_2 <- lm(cost ~ iwage,data=df)
summary(model_2)
```

*3. Calculeu un model lineal per al cost objectiu utilitzant totes les variables numÃ¨riques disponibles. Hi ha problemes de colinealitat al model? Justifiqueu la soluciÃ³ per eliminar la colinealitat.*
El model que utilitza variables numÃ¨riques ha de contenir risc, fatalisme, edat, lifeExp com a caracterÃ­stiques del fabricant de viatges i puntuacions numÃ¨riques de seients, soroll, multitud, convlocaciÃ³ i clientela. 

El model explica el 65,88% de la variabilitat de costos. 

NomÃ©s els efectes nets de multitud i d'efecte sÃ³n significatius al llindar habitual del 5%, perÃ² el valor de soroll no ho Ã©s fins ara i s'ha d'incloure tambÃ© com a variable notable. 

Utilitzant el mÃ¨tode vif, el parell de soroll i multitud sembla estar correlacionat i el parell dâ€™edat i lifeExp tambÃ©. 

Heu de conservar una variable en cada parell, ja sigui la mÃ©s correlacionada o la mÃ©s fiable: trio multitud per resoldre el primer problema de parell i l'edat del segon (variable mÃ©s objectiva que lifeExp). 

Podeu veure que m4 que contÃ© tots els nÃºmeros, excepte el soroll i lifeExp, ha resolt problemes de colineari. 

Si sâ€™eliminen variables no significatives, nomÃ©s es conserven els valors i la multitud.

```{r}
model_3 <- lm(
  cost~
    risk +
    seats +
    noise +
    crowdness +
    convloc +
    clientele +
    lifeExp +
    iwage +
    fatalism +
    age   
  ,data=df
); summary(model_3)
vif(model_3)


model_4<-lm(
  cost~
    risk+
    seats+
    crowdness+
    convloc+
    clientele+
    age+
    iwage+
    fatalism
  ,data=df
); summary(model_4)
vif(model_4)


model_5<-step(model_4,k=log(nrow(df))); summary(model_5)

```

*4. Un cop proposat el millor model de cost objectiu que utilitza variables numÃ¨riques explicatives, cal incloure algun efecte principal significatiu? I les interaccions? Justifiqueu la vostra resposta.*

Les transformacions a variables explicatives no es consideren a lâ€™exercici, perÃ² sÃ­ que sâ€™haurien de provar en un estudi real. 

Es considera el model m7 <-lm (cost ~ multitud + iwage + mode + sexe + african + educ + haveChildren + swim, data = df) i Anova (m7) mostra que les variables so me sÃ³n redundants, essent nomÃ©s crowdness, iwage, mode, gÃ¨nere, africÃ  i e duc aquells amb efectes nets significatius. 

Les interaccions entre factors i covariables estan incloses: alguns missatges de coeficients aliats indiquen un problema dâ€™especificaciÃ³: les interaccions de mode i multitud no es poden calcular, de manera que no es tÃ© en compte la interacciÃ³ de mode i multitud. 

DesprÃ©s del cÃ lcul i reducciÃ³ del model model_8 mitjanÃ§ant el mÃ¨tode step () amb monitoratge BIC, un model final (m9) que contÃ©:

cost ~ iwage + mode + crowdness + gender + african + educ + iwage:mode + crowdness:african + crowdness:educ + iwage:african

Ã‰s un model complex que explica el 84% de la variabilitat de costos.

```{r}
model_7<-lm(cost~crowdness+iwage+mode+gender+african+educ+haveChildren+swim, data= df)
summary(model_7)
Anova(model_7)
model_8<-lm(cost~(crowdness+iwage)*(mode+gender+african+educ+haveChildren+swim), data=df) # Some crwodness:mode parameters can not be estimated
summary(model_8)
Anova(model_8)
model_8<-lm(cost~iwage*mode+(crowdness+iwage)*(gender+african+educ+haveChildren+swim), data=df)
summary(model_8)
Anova(model_8)

model_9<-step(model_8,k=log(nrow(df)))
summary(model_9)
Anova(model_9)
```

*5. Seleccioneu el millor model disponible fins ara. Suposem una observaciÃ³ sobre la mediana de les variables numÃ¨riques i els nivells de referÃ¨ncia dels factors. Calculeu un interval de confianÃ§a del 90% per al cost de transferÃ¨ncia previst.*
Es pot respondre fÃ cilment a aquesta pregunta mitjanÃ§ant el mÃ¨tode predict (). El meu millor model Ã©s model_1: el mode on e amb iwage *, ja que explica gairebÃ© el 80% de l'objectiu i Ã©s mÃ©s senzill que m9 (explicant el 84%). Les respostes que inclouen el millor model obtingut desprÃ©s de la pregunta 5 tambÃ© s'han considerat correctes.
La mitjana de iwage Ã©s 27.96236 i el nivell de referÃ¨ncia per al mode Ã©s "Helicopter"
Per al mode == HelicÃ²pter Y = (37,14 + 0) + (2,33 + 0) * iwage = 37,14 + 2,33 * 27,96 = 102,2525 $ Ã©s la valoraciÃ³ puntual. L'interval de confianÃ§a del 90% del cost previst no es pot calcular fÃ cilment sense utilitzar el mÃ¨tode predict (model, newdata =.) A R.

```{r}
predict(model_1,newdata=data.frame(iwage=median(df$iwage),mode="Helicopter"),interval="prediction",level=0.9)
```

*6. Valora grÃ ficament el millor model obtingut fins ara. Avalueu la presÃ¨ncia de valors atÃ­pics en els residus estudiats amb un nivell de confianÃ§a del 95%. Indiqueu quines sÃ³n aquestes observacions i per quÃ¨ mostren falta dâ€™ajust.*
De nou, model_1 Ã©s el meu millor model fins ara, perÃ² tambÃ© pot ser el millor model obtingut a la pregunta 4
usat. El diagnÃ²stic demostra que el model no Ã©s bo. Com que es tracta dâ€™una pregunta en un examen, vosaltres
heu de respondre a la manca de problemes dâ€™ajust. Els residus absoluts estudiats superiors a 3,0 es consideren
tliers i corresponen a les observacions 45 i 46 en lâ€™ordre del registre df o els noms de pila â€œ
627 â€iâ€œ 631 â€. Aquests registres pertanyen a dones joves per les quals han pagat molts diners
un servei dâ€™hovercraft fins al centre de la ciutat. Hi ha dades influents i les transformacions serien n
Es van obtenir variables explicatives i resultats, perÃ² aquest no Ã©s l'objectiu d'aquest examen.

```{r}
qnorm(0.975)
ll<-which(abs(rstudent(model_1))>qnorm(0.975));ll;length(ll)
df[ll,]
ll<-which(abs(rstudent(model_1))>3.0);ll
df[ll,]
```

*7. Estudiar la presÃ¨ncia dâ€™observacions de dades influents a priori i a posteriori. Indiqueu els llindars que sâ€™han dâ€™aplicar a lâ€™estadÃ­stica implicada en el diagnÃ²stic.*
```{r}
influencePlot(model_1,id=list(method="noteworthy",n=3))
3*mean(hatvalues(model_1))
llhii<-which(hatvalues(model_1)>3*mean(hatvalues(model_1)));length(llhii)
```

FÃ cilment utilitzant influencePlot (model). Els usuaris dâ€™helicÃ²pters sÃ³n nomÃ©s 2 a la mostra i aquestes sÃ³n les dades influents: no hi ha cap model que pugui tractar 4 modes donada la baixa quota de mercat de lâ€™helicÃ²pter. Aquestes observacions sâ€™han dâ€™eliminar i sâ€™ha de repetir lâ€™exercici de nou.

```{r}
influencePlot(model_1)
df[c("779","4785"),]
table(df$mode)
```


*8. El factor dâ€™elecciÃ³ binÃ ria WaterTaxi Ã©s el nou objectiu a tractar. Calculeu un model de logit que inclogui seients, multitud, covariables de convlocaciÃ³ i factors educatius i de nataciÃ³. Discutiu l'adequaciÃ³ del model tenint en compte les tendÃ¨ncies marginals i les parcelÂ·les residuals.*
Es mostra certa manca dâ€™ajust a les parcelÂ·les marginals per a seients i principalment a les puntuacions de gent, de totes maneres, les parcelÂ·les residuals mostren un greix mÃ©s suau per a lâ€™ajust global (Ãºltima trama, just a sota). Tots els factors i covariables tenen efectes nets significatius segons el mÃ¨tode Anova (). No hi ha cap arxiu de collina al model.
Com que la desviaciÃ³ residual Ã©s de 376,95 en 411 graus de llibertat i les dades desagregades sÃ³n el tipus dâ€™aquest conjunt de dades, mitjanÃ§ant la prÃ ctica Â«regla generalÂ» que indica que la desviaciÃ³ residual no ha de ser inferior a d.ll. i aixÃ² es mantÃ© com es mostra a la sortida.

```{r}
m20<-glm(f.water_taxi~seats+crowdness+convloc+educ+swim, family=binomial, data=df) 
summary(m20)
Anova(m20,test="LR")
vif(m20)
```

*9. Interpretar les equacions del model i els efectes en lâ€™escala de probabilitats dels factors implicats.*
â€¢ ð›¾ð›¾1 = 0 ð›¾ð›¾2 = ðŸðŸ. ðŸðŸðŸðŸðŸðŸðŸðŸ for factor educ, where level 1 is education-low and 2 is education-
high.
â€¢ ð›¿ð›¿ = 0 ð›¿ð›¿ = ðŸðŸ. ðŸ•ðŸ•ðŸ•ðŸ•ðŸ•ðŸ•ðŸ•ðŸ• for factor swim, where level 1 is swim-No and 2 is swim-Yes
â€¢ There are as many model equations as 2 x 2= 4 (product of number of levels for factor s educ and swim)
Interpretation of the model in the odds scale:
Increasing by 0.1 units seats scored then exp(-2.47*0.1)= 0.7811407 -> 100*(1-0.7811)= 22%, the odds of the probability of choosing WaterTaxi decreases by 22%, all else being equal.
Increasing by 0.1 units seats scored then exp(4.15*0.1)= 1.514371
-> 100*(1.514371-1)=51%, the odds of the probability of choosing WaterTaxi increases b
y 51%, all else being equal.
Increasing by 0.1 units seats scored then exp(5.47*0.1)= 1.728061
-> 100*( 1.728061-1)=72%, the odds of the probability of choosing WaterTaxi increases b y 72%, all else being equal.
The odds of the probability of choosing WaterTaxi for high educated people increases by e xp(1.1201)=3.065 -> 100*(3.065 -1)= 206% the probability of choosing WaterTaxi in the reference level education-low all else being equal.
The odds of the probability of choosing WaterTaxi for people that can swim increases by e xp(0.7489)= 2.114-> 100*(2.114 -1)= 111% the probability of choosing WaterTaxi in the reference level of people that cannot swim, all else being equal.

```{r}
summary(m20)
exp(coef(m20))
```

*10. Quina seria la probabilitat esperada dâ€™utilitzar un â€˜WaterTaxiâ€™ per a un fabricant de viatges nedadors i dâ€™educaciÃ³ superior quan les variables explicatives numÃ¨riques sâ€™estableixen al mÃ­nim de mostra?*
```{r}
predict(m20,newdata=data.frame(seats=min(df$seats),crowdness=min(df$crowdness),convloc=min(df$convloc),educ="high",swim="swim.No"),type="response",se.fit=T,level=0.95)
```
